<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Grafik Status Pengungsi & Korban</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

        <!-- CSS & Library Leaflet -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    </head>
    <body class="bg-gray-100 min-h-screen flex flex-col items-center justify-start p-6 gap-8 pb-20">
        <div class="grid md:grid-cols-4 gap-6 w-full">
            <!-- Total Korban -->
            <div class="bg-white rounded-2xl shadow-lg p-5 sm:p-6 md:p-8 flex flex-col items-center">
                <h2 class="text-lg sm:text-2xl font-bold text-gray-800 mb-2 text-center">Total Korban</h2>
                <p id="totalKorbanAll" class="text-2xl sm:text-4xl font-extrabold text-red-600">0</p>
            </div>

            <!-- Laki-laki -->
            <div class="bg-white rounded-2xl shadow-lg p-5 sm:p-6 md:p-8 flex flex-col items-center">
                <h2 class="text-lg sm:text-2xl font-bold text-gray-800 mb-2 text-center">Laki-laki</h2>
                <p id="totalKorbanLaki" class="text-2xl sm:text-4xl font-extrabold text-red-600">0</p>
            </div>

            <!-- Perempuan -->
            <div class="bg-white rounded-2xl shadow-lg p-5 sm:p-6 md:p-8 flex flex-col items-center">
                <h2 class="text-lg sm:text-2xl font-bold text-gray-800 mb-2 text-center">Perempuan</h2>
                <p id="totalKorbanPerempuan" class="text-2xl sm:text-4xl font-extrabold text-red-600">0</p>
            </div>

            <!-- Data tidak lengkap -->
            <div class="bg-white rounded-2xl shadow-lg p-5 sm:p-6 md:p-8 flex flex-col items-center">
                <h2 class="text-lg sm:text-2xl font-bold text-gray-800 mb-2 text-center">Tanpa Status Jenis Kelamin</h2>
                <p id="totalKorbanTidakLengkap" class="text-2xl sm:text-4xl font-extrabold text-red-600">0</p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 w-full">
            <!-- Card Data Pengungsi -->
            <div class="bg-white rounded-2xl shadow-lg p-5 sm:p-6 md:p-8 w-full">
                <h2 class="text-lg sm:text-2xl font-bold text-gray-800 mb-4 text-center">📋 Data Status Pengungsi</h2>
                <div class="overflow-x-auto">
                    <table id="tablePengungsi" class="min-w-full text-sm text-left text-gray-600">
                        <thead class="bg-gray-100 text-gray-700">
                            <tr>
                                <th class="px-4 py-2">Status Mengungsi</th>
                                <th class="px-4 py-2">Jumlah</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Card Data Korban -->
            <div class="bg-white rounded-2xl shadow-lg p-5 sm:p-6 md:p-8 w-full">
                <h2 class="text-lg sm:text-2xl font-bold text-gray-800 mb-4 text-center">📋 Data Status Korban</h2>
                <div class="overflow-x-auto">
                    <table id="tableKorban" class="min-w-full text-sm text-left text-gray-600">
                        <thead class="bg-gray-100 text-gray-700">
                            <tr>
                                <th class="px-4 py-2">Status Korban</th>
                                <th class="px-4 py-2">Jumlah</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Chart Status Pengungsi -->
            <div class="bg-white rounded-2xl shadow-lg p-5 sm:p-6 md:p-8">
                <h2 class="text-lg sm:text-2xl font-bold text-gray-800 mb-2 sm:mb-4 text-center">📊 Status Pengungsi</h2>
                <p class="text-xs sm:text-sm text-gray-500 mb-4 text-center">Statistik real-time dari Google Sheet</p>

                <!-- Chart -->
                <div class="relative w-full">
                    <div class="aspect-[4/3] sm:aspect-[16/9]">
                        <canvas id="pengungsiChart" class="w-full h-full"></canvas>
                    </div>
                </div>

                <p class="text-xs sm:text-sm text-gray-500 mt-4 text-center">🔄 Data diperbarui otomatis setiap <span class="font-semibold">3 menit</span></p>
            </div>

            <!-- Chart Status Korban -->
            <div class="bg-white rounded-2xl shadow-lg p-5 sm:p-6 md:p-8">
                <h2 class="text-lg sm:text-2xl font-bold text-gray-800 mb-2 sm:mb-4 text-center">📊 Status Korban</h2>
                <p class="text-xs sm:text-sm text-gray-500 mb-4 text-center">Statistik real-time dari Google Sheet</p>

                <!-- Chart -->
                <div class="relative w-full">
                    <div class="aspect-[4/3] sm:aspect-[16/9]">
                        <canvas id="korbanChart" class="w-full h-full"></canvas>
                    </div>
                </div>

                <p class="text-xs sm:text-sm text-gray-500 mt-4 text-center">🔄 Data diperbarui otomatis setiap <span class="font-semibold">3 menit</span></p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full">
            <!-- Chart Jenis Kerusakan -->
            <div class="bg-white rounded-2xl shadow-lg p-5 sm:p-6 md:p-8">
                <h2 class="text-lg sm:text-2xl font-bold text-gray-800 mb-2 sm:mb-4 text-center">📊 Jenis Kerusakan</h2>
                <p class="text-xs sm:text-sm text-gray-500 mb-4 text-center">Statistik real-time dari Google Sheet</p>

                <!-- Chart -->
                <div class="relative w-full">
                    <div class="aspect-[4/3] sm:aspect-[16/9]">
                        <canvas id="kerusakanChart" class="w-full h-full"></canvas>
                    </div>
                </div>

                <p class="text-xs sm:text-sm text-gray-500 mt-4 text-center">🔄 Data diperbarui otomatis setiap <span class="font-semibold">3 menit</span></p>
            </div>

            <!-- Grafik Kecamatan -->
            <div class="bg-white rounded-2xl shadow-lg p-5 sm:p-6 md:p-8">
                <h2 class="text-lg sm:text-2xl font-bold text-gray-800 mb-2 sm:mb-4 text-center">📊 Sebaran Data per Kecamatan</h2>
                <p class="text-xs sm:text-sm text-gray-500 mb-4 text-center">Statistik real-time dari Google Sheet</p>

                <div class="relative w-full">
                    <div class="aspect-[4/3] sm:aspect-[16/9]">
                        <canvas id="kecamatanChart" class="w-full h-full"></canvas>
                    </div>
                </div>

                <p class="text-xs sm:text-sm text-gray-500 mt-4 text-center">🔄 Data diperbarui otomatis setiap <span class="font-semibold">3 menit</span></p>
            </div>
        </div>

        <!-- Peta Lokasi Korban -->
        <!-- <div class="bg-white rounded-2xl shadow-lg p-5 sm:p-6 md:p-8 w-full">
            <h2 class="text-lg sm:text-2xl font-bold text-gray-800 mb-4 text-center">🗺️ Peta Lokasi Korban</h2>
            <div id="map" class="w-full h-[600px] rounded-lg"></div>
        </div> -->

        <!-- Sticky Footer -->
        <footer class="w-full bg-gray-800 text-gray-200 py-4 mt-8 fixed bottom-0 left-0">
            <div class="flex flex-col md:flex-row justify-between items-center px-6">
                <p class="text-sm">&copy; 2025 Dashboard Pemantauan Korban Banjir. Created by Tim SPBE Kominfos Denpasar</p>
                <p class="text-sm mt-2 md:mt-0">Data berasal dari Google Sheets resmi.</p>
                <p id="lastUpdate" class="text-sm mt-2 md:mt-0 text-yellow-300">asdasd</p>
            </div>
        </footer>

        <script>
            const spreadsheetId = "1pyXzTvTl6BAkech4z4b1BhmR5aEBpAvZ";

            // Sheet Names
            const sheetPengungsi = "dashboardStatusPengungsi";
            const sheetKorban = "dashboardStatusKorban";
            const sheetKecamatan = "dashboardKecamatan";
            const sheetKerusakan = "dashboardJenisKerusakan";

            // Chart instances
            let pengungsiChart;
            let korbanChart;
            let kecamatanChart;
            let kerusakanChart;

            // Default types
            let typePengungsi = "pie";
            let typeKorban = "bar";
            let typeKecamatan = "pie";
            let typeKerusakan = "bar";

            // Fungsi load data dari Google Sheet
            async function loadData(sheetName, chartId, chartRef, currentType) {
                const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&sheet=${sheetName}`;
                const res = await fetch(url);
                const rep = await res.text();
                const jsonData = JSON.parse(rep.substring(47).slice(0, -2));
                const rows = jsonData.table.rows;

                const labels = rows.map((r) => r.c[0]?.v);
                const data = rows.map((r) => r.c[1]?.v);

                const ctx = document.getElementById(chartId).getContext("2d");

                if (chartRef.value) chartRef.value.destroy();

                chartRef.value = new Chart(ctx, {
                    type: currentType,
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: "Jumlah",
                                data: data,
                                backgroundColor: [
                                    "rgba(239, 68, 68, 0.7)", // merah
                                    "rgba(59, 130, 246, 0.7)", // biru
                                    "rgba(245, 158, 11, 0.7)", // kuning
                                    "rgba(34, 197, 94, 0.7)", // hijau
                                    "rgba(168, 85, 247, 0.7)", // ungu
                                    "rgba(251, 191, 36, 0.7)", // amber
                                    "rgba(107, 114, 128, 0.7)", // abu
                                ],
                                borderColor: ["rgba(239, 68, 68, 1)", "rgba(59, 130, 246, 1)", "rgba(245, 158, 11, 1)", "rgba(34, 197, 94, 1)", "rgba(168, 85, 247, 1)", "rgba(251, 191, 36, 1)", "rgba(107, 114, 128, 1)"],
                                borderWidth: 1,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: currentType === "pie" ? "bottom" : "top",
                                labels: { font: { size: 12 } },
                            },
                            datalabels: {
                                color: "#000",
                                font: { weight: "bold", size: 12 },
                                anchor: "center",
                                align: currentType === "bar" ? "end" : "center",
                                formatter: (value, context) => {
                                    if (currentType === "pie") {
                                        const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        const percent = ((value / total) * 100).toFixed(1);
                                        return `${value} (${percent}%)`;
                                    } else {
                                        return value;
                                    }
                                },
                            },
                        },
                        scales:
                            currentType === "bar"
                                ? {
                                      y: {
                                          beginAtZero: true,
                                          ticks: { stepSize: 100 },
                                      },
                                  }
                                : {},
                    },
                    plugins: [ChartDataLabels],
                });
            }

            // Load semua grafik pertama kali
            loadData(
                sheetPengungsi,
                "pengungsiChart",
                {
                    get value() {
                        return pengungsiChart;
                    },
                    set value(v) {
                        pengungsiChart = v;
                    },
                },
                typePengungsi
            );

            loadData(
                sheetKorban,
                "korbanChart",
                {
                    get value() {
                        return korbanChart;
                    },
                    set value(v) {
                        korbanChart = v;
                    },
                },
                typeKorban
            );

            loadData(
                sheetKecamatan,
                "kecamatanChart",
                {
                    get value() {
                        return kecamatanChart;
                    },
                    set value(v) {
                        kecamatanChart = v;
                    },
                },
                typeKecamatan
            );

            loadData(
                sheetKerusakan,
                "kerusakanChart",
                {
                    get value() {
                        return kerusakanChart;
                    },
                    set value(v) {
                        kerusakanChart = v;
                    },
                },
                typeKerusakan
            );

            // Refresh tiap 3 menit
            setInterval(() => {
                loadData(
                    sheetPengungsi,
                    "pengungsiChart",
                    {
                        get value() {
                            return pengungsiChart;
                        },
                        set value(v) {
                            pengungsiChart = v;
                        },
                    },
                    typePengungsi
                );
                loadData(
                    sheetKorban,
                    "korbanChart",
                    {
                        get value() {
                            return korbanChart;
                        },
                        set value(v) {
                            korbanChart = v;
                        },
                    },
                    typeKorban
                );
                loadData(
                    sheetKecamatan,
                    "kecamatanChart",
                    {
                        get value() {
                            return kecamatanChart;
                        },
                        set value(v) {
                            kecamatanChart = v;
                        },
                    },
                    typeKecamatan
                );
                loadData(
                    sheetKerusakan,
                    "kerusakanChart",
                    {
                        get value() {
                            return kerusakanChart;
                        },
                        set value(v) {
                            kerusakanChart = v;
                        },
                    },
                    typeKerusakan
                );
            }, 180000);

            // Event listener tombol toggle (jika disiapkan tombolnya di HTML)
            document.getElementById("pieBtnPengungsi")?.addEventListener("click", () => {
                typePengungsi = "pie";
                loadData(
                    sheetPengungsi,
                    "pengungsiChart",
                    {
                        get value() {
                            return pengungsiChart;
                        },
                        set value(v) {
                            pengungsiChart = v;
                        },
                    },
                    typePengungsi
                );
            });
            document.getElementById("barBtnPengungsi")?.addEventListener("click", () => {
                typePengungsi = "bar";
                loadData(
                    sheetPengungsi,
                    "pengungsiChart",
                    {
                        get value() {
                            return pengungsiChart;
                        },
                        set value(v) {
                            pengungsiChart = v;
                        },
                    },
                    typePengungsi
                );
            });

            document.getElementById("pieBtnKorban")?.addEventListener("click", () => {
                typeKorban = "pie";
                loadData(
                    sheetKorban,
                    "korbanChart",
                    {
                        get value() {
                            return korbanChart;
                        },
                        set value(v) {
                            korbanChart = v;
                        },
                    },
                    typeKorban
                );
            });
            document.getElementById("barBtnKorban")?.addEventListener("click", () => {
                typeKorban = "bar";
                loadData(
                    sheetKorban,
                    "korbanChart",
                    {
                        get value() {
                            return korbanChart;
                        },
                        set value(v) {
                            korbanChart = v;
                        },
                    },
                    typeKorban
                );
            });

            document.getElementById("pieBtnKecamatan")?.addEventListener("click", () => {
                typeKecamatan = "pie";
                loadData(
                    sheetKecamatan,
                    "kecamatanChart",
                    {
                        get value() {
                            return kecamatanChart;
                        },
                        set value(v) {
                            kecamatanChart = v;
                        },
                    },
                    typeKecamatan
                );
            });
            document.getElementById("barBtnKecamatan")?.addEventListener("click", () => {
                typeKecamatan = "bar";
                loadData(
                    sheetKecamatan,
                    "kecamatanChart",
                    {
                        get value() {
                            return kecamatanChart;
                        },
                        set value(v) {
                            kecamatanChart = v;
                        },
                    },
                    typeKecamatan
                );
            });

            document.getElementById("pieBtnKerusakan")?.addEventListener("click", () => {
                typeKerusakan = "pie";
                loadData(
                    sheetKerusakan,
                    "kerusakanChart",
                    {
                        get value() {
                            return kerusakanChart;
                        },
                        set value(v) {
                            kerusakanChart = v;
                        },
                    },
                    typeKerusakan
                );
            });
            document.getElementById("barBtnKerusakan")?.addEventListener("click", () => {
                typeKerusakan = "bar";
                loadData(
                    sheetKerusakan,
                    "kerusakanChart",
                    {
                        get value() {
                            return kerusakanChart;
                        },
                        set value(v) {
                            kerusakanChart = v;
                        },
                    },
                    typeKerusakan
                );
            });

            function updateLastUpdated() {
                const now = new Date();
                const formatted = now.toLocaleString("id-ID", {
                    weekday: "long",
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                    hour: "2-digit",
                    minute: "2-digit",
                    second: "2-digit",
                });
                document.getElementById("lastUpdate").textContent = `Terakhir diperbarui: ${formatted}`;
            }

            async function loadData(sheetName, chartId, chartRef, currentType) {
                const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&sheet=${sheetName}`;
                const res = await fetch(url);
                const rep = await res.text();
                const jsonData = JSON.parse(rep.substring(47).slice(0, -2));
                const rows = jsonData.table.rows;

                const labels = rows.map((r) => r.c[0]?.v);
                const data = rows.map((r) => r.c[1]?.v);

                const ctx = document.getElementById(chartId).getContext("2d");

                if (chartRef.value) chartRef.value.destroy();

                chartRef.value = new Chart(ctx, {
                    type: currentType,
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: "Jumlah",
                                data: data,
                                backgroundColor: ["rgba(239, 68, 68, 0.7)", "rgba(59, 130, 246, 0.7)", "rgba(245, 158, 11, 0.7)", "rgba(34, 197, 94, 0.7)", "rgba(168, 85, 247, 0.7)", "rgba(251, 191, 36, 0.7)", "rgba(107, 114, 128, 0.7)"],
                                borderWidth: 1,
                            },
                        ],
                    },
                    options: { responsive: true },
                    plugins: [ChartDataLabels],
                });

                // update footer setelah data berhasil diload
                updateLastUpdated();
            }

            // Load semua grafik
            loadData("dashboardPengungsi", "chartPengungsi", pengungsiChart, "bar");
            loadData("dashboardKorban", "chartKorban", korbanChart, "bar");
            loadData("dashboardKecamatan", "chartKecamatan", kecamatanChart, "pie");
            loadData("dashboardKerusakan", "chartKerusakan", kerusakanChart, "bar");
        </script>

        <script>
            function renderTable(sheetName, tableId) {
                const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&sheet=${sheetName}`;
                fetch(url)
                    .then((res) => res.text())
                    .then((rep) => {
                        const jsonData = JSON.parse(rep.substring(47).slice(0, -2));
                        const rows = jsonData.table.rows;
                        const tbody = document.querySelector(`#${tableId} tbody`);
                        tbody.innerHTML = ""; // bersihkan tabel
                        rows.forEach((r) => {
                            const status = r.c[0].v;
                            const jumlah = r.c[1].v;
                            tbody.innerHTML += `<tr class="border-b hover:bg-gray-50"><td class="px-4 py-2">${status}</td><td class="px-4 py-2">${jumlah}</td></tr>`;
                        });
                    });
            }

            // Panggil setelah load chart
            renderTable(sheetPengungsi, "tablePengungsi");
            renderTable(sheetKorban, "tableKorban");

            // Refresh setiap 3 menit
            setInterval(() => {
                renderTable(sheetPengungsi, "tablePengungsi");
                renderTable(sheetKorban, "tableKorban");
            }, 180000);
        </script>

        <script>
            function updateTotalKorban(sheetName) {
                const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&sheet=${sheetName}`;
                fetch(url)
                    .then((res) => res.text())
                    .then((rep) => {
                        const jsonData = JSON.parse(rep.substring(47).slice(0, -2));
                        const rows = jsonData.table.rows;

                        rows.forEach((r) => {
                            const label = r.c[0].v.toLowerCase();
                            const value = r.c[1].v;

                            if (label.includes("total data korban")) {
                                document.getElementById("totalKorbanAll").textContent = value;
                            } else if (label.includes("laki")) {
                                document.getElementById("totalKorbanLaki").textContent = value;
                            } else if (label.includes("perempuan")) {
                                document.getElementById("totalKorbanPerempuan").textContent = value;
                            } else if (label.includes("tidak lengkap")) {
                                document.getElementById("totalKorbanTidakLengkap").textContent = value;
                            }
                        });
                    });
            }

            // Panggil setelah load halaman
            updateTotalKorban("dashboardTotalKorbanMasuk");

            // Refresh tiap 3 menit
            setInterval(() => {
                updateTotalKorban("dashboardTotalKorbanMasuk");
            }, 180000);
        </script>

        <script>
            const sheetKoordinat = "dashboardKoordinatPeta";

            // Inisialisasi peta
            const map = L.map("map").setView([-8.65, 115.22], 12);

            // Tambah layer OpenStreetMap
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                attribution: "© OpenStreetMap contributors",
            }).addTo(map);

            // Fungsi load data dari Google Sheet
            async function loadMapData() {
                const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&sheet=${sheetKoordinat}`;
                const res = await fetch(url);
                const rep = await res.text();
                const jsonData = JSON.parse(rep.substring(47).slice(0, -2));
                const rows = jsonData.table.rows;

                // Hapus marker lama
                map.eachLayer((layer) => {
                    if (layer instanceof L.Marker) map.removeLayer(layer);
                });

                rows.forEach((r) => {
                    const nama = r.c[0]?.v; // Nama Lokasi
                    const lat = r.c[2]?.v; // Latidute
                    const lng = r.c[3]?.v; // Longtidue
                    const fileId = r.c[5]?.v; // Ambil File ID

                    if (lat && lng) {
                        const fotoUrl = fileId ? `https://drive.google.com/uc?export=view&id=${fileId}` : "";

                        // Buat element image dengan fallback jika gagal load
                        const imgHtml = fotoUrl
                            ? `<img src="${fotoUrl}" class="popup-img" onerror="this.onerror=null;this.replaceWith(document.createElement('div').innerHTML='<div class=\\'popup-placeholder\\'>Gambar tidak tersedia</div>');">`
                            : "";

                        L.marker([lat, lng]).addTo(map).bindPopup(`<b>${nama}</b>${imgHtml}`);
                    }
                });
            }

            // Panggil pertama kali
            loadMapData();

            // Refresh setiap 3 menit
            setInterval(loadMapData, 180000);
        </script>
    </body>
</html>
